package com.incident.controller;

import com.incident.model.Incident;
import com.incident.model.User;
import com.incident.service.IncidentService;
import java.io.IOException;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

@WebServlet("/incident/*")
public class IncidentController extends HttpServlet {
    private IncidentService incidentService;
    
    @Override
    public void init() {
        incidentService = new IncidentService();
    }
    
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        
        HttpSession session = request.getSession(false);
        if (session == null || session.getAttribute("user") == null) {
            response.sendRedirect(request.getContextPath() + "/login.jsp");
            return;
        }
        
        User user = (User) session.getAttribute("user");
        String action = request.getPathInfo();
        
        if (action == null) {
            response.sendError(HttpServletResponse.SC_BAD_REQUEST);
            return;
        }
        
        switch (action) {
            case "/view":
                handleViewIncident(request, response, user);
                break;
            case "/create":
                request.getRequestDispatcher("/citizen/report-incident.jsp").forward(request, response);
                break;
            case "/list":
                handleListIncidents(request, response, user);
                break;
            case "/search":
                handleSearchIncidents(request, response, user);
                break;
            default:
                response.sendError(HttpServletResponse.SC_NOT_FOUND);
        }
    }
    
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        
        HttpSession session = request.getSession(false);
        if (session == null || session.getAttribute("user") == null) {
            response.sendRedirect(request.getContextPath() + "/login.jsp");
            return;
        }
        
        User user = (User) session.getAttribute("user");
        String action = request.getPathInfo();
        
        if (action == null) {
            response.sendError(HttpServletResponse.SC_BAD_REQUEST);
            return;
        }
        
        switch (action) {
            case "/create":
                handleCreateIncident(request, response, user);
                break;
            case "/update":
                handleUpdateIncident(request, response, user);
                break;
            case "/delete":
                handleDeleteIncident(request, response, user);
                break;
            default:
                response.sendError(HttpServletResponse.SC_NOT_FOUND);
        }
    }
    
    private void handleViewIncident(HttpServletRequest request, HttpServletResponse response, User user)
            throws ServletException, IOException {
        
        try {
            int incidentId = Integer.parseInt(request.getParameter("id"));
            Incident incident = incidentService.getIncidentById(incidentId);
            
            if (incident == null) {
                request.setAttribute("error", "Incident not found");
                redirectToDashboard(user, request, response);
                return;
            }
            
            // Check permission based on role
            boolean hasPermission = false;
            switch (user.getRole()) {
                case "ADMIN":
                    hasPermission = true;
                    break;
                case "OFFICER":
                    hasPermission = (incident.getAssignedTo() != null && 
                                   incident.getAssignedTo() == user.getUserId()) ||
                                   user.getUserId() == incident.getReportedBy();
                    break;
                case "CITIZEN":
                    hasPermission = user.getUserId() == incident.getReportedBy();
                    break;
            }
            
            if (!hasPermission) {
                request.setAttribute("error", "You don't have permission to view this incident");
                redirectToDashboard(user, request, response);
                return;
            }
            
            request.setAttribute("incident", incident);
            
            // Forward to appropriate view page
            String viewPage = "/" + user.getRole().toLowerCase() + "/incident-details.jsp";
            request.getRequestDispatcher(viewPage).forward(request, response);
            
        } catch (NumberFormatException e) {
            request.setAttribute("error", "Invalid incident ID");
            redirectToDashboard(user, request, response);
        }
    }
    
    private void handleCreateIncident(HttpServletRequest request, HttpServletResponse response, User user)
            throws ServletException, IOException {
        
        if (!user.getRole().equals("CITIZEN")) {
            request.setAttribute("error", "Only citizens can report incidents");
            redirectToDashboard(user, request, response);
            return;
        }
        
        Incident incident = new Incident();
        incident.setTitle(request.getParameter("title"));
        incident.setDescription(request.getParameter("description"));
        incident.setCategory(request.getParameter("category"));
        incident.setLocation(request.getParameter("location"));
        incident.setSeverity(request.getParameter("severity"));
        incident.setStatus("PENDING");
        incident.setReportedBy(user.getUserId());
        
        int incidentId = incidentService.reportIncident(incident);
        
        if (incidentId > 0) {
            request.setAttribute("success", "Incident reported successfully with ID: " + incidentId);
            response.sendRedirect(request.getContextPath() + "/citizen/my-reports.jsp");
        } else {
            request.setAttribute("error", "Failed to report incident");
            request.getRequestDispatcher("/citizen/report-incident.jsp").forward(request, response);
        }
    }
    
    private void handleUpdateIncident(HttpServletRequest request, HttpServletResponse response, User user)
            throws ServletException, IOException {
        
        try {
            int incidentId = Integer.parseInt(request.getParameter("incidentId"));
            Incident incident = incidentService.getIncidentById(incidentId);
            
            if (incident == null) {
                request.setAttribute("error", "Incident not found");
                redirectToDashboard(user, request, response);
                return;
            }
            
            // Check permission
            boolean hasPermission = false;
            switch (user.getRole()) {
                case "ADMIN":
                    hasPermission = true;
                    break;
                case "OFFICER":
                    hasPermission = (incident.getAssignedTo() != null && 
                                   incident.getAssignedTo() == user.getUserId());
                    break;
                case "CITIZEN":
                    hasPermission = user.getUserId() == incident.getReportedBy();
                    break;
            }
            
            if (!hasPermission) {
                request.setAttribute("error", "You don't have permission to update this incident");
                redirectToDashboard(user, request, response);
                return;
            }
            
            // Update fields based on role
            if (user.getRole().equals("ADMIN") || user.getRole().equals("OFFICER")) {
                incident.setTitle(request.getParameter("title"));
                incident.setDescription(request.getParameter("description"));
                incident.setCategory(request.getParameter("category"));
                incident.setLocation(request.getParameter("location"));
                incident.setSeverity(request.getParameter("severity"));
                incident.setStatus(request.getParameter("status"));
                
                String assignedToStr = request.getParameter("assignedTo");
                if (assignedToStr != null && !assignedToStr.isEmpty()) {
                    incident.setAssignedTo(Integer.parseInt(assignedToStr));
                }
                
                if ("RESOLVED".equals(request.getParameter("status"))) {
                    // Set resolved date if status is RESOLVED
                    java.util.Date currentDate = new java.util.Date();
                    incident.setResolvedDate(new java.sql.Timestamp(currentDate.getTime()));
                }
            } else if (user.getRole().equals("CITIZEN")) {
                // Citizens can only update title, description, and location
                incident.setTitle(request.getParameter("title"));
                incident.setDescription(request.getParameter("description"));
                incident.setLocation(request.getParameter("location"));
            }
            
            boolean success = incidentService.updateIncident(incident);
            
            if (success) {
                request.setAttribute("success", "Incident updated successfully");
            } else {
                request.setAttribute("error", "Failed to update incident");
            }
            
            response.sendRedirect(request.getContextPath() + "/incident/view?id=" + incidentId);
            
        } catch (NumberFormatException e) {
            request.setAttribute("error", "Invalid incident ID");
            redirectToDashboard(user, request, response);
        }
    }
    
    private void handleDeleteIncident(HttpServletRequest request, HttpServletResponse response, User user)
            throws ServletException, IOException {
        
        if (!user.getRole().equals("ADMIN")) {
            request.setAttribute("error", "Only administrators can delete incidents");
            redirectToDashboard(user, request, response);
            return;
        }
        
        try {
            int incidentId = Integer.parseInt(request.getParameter("id"));
            boolean success = incidentService.deleteIncident(incidentId);
            
            if (success) {
                request.setAttribute("success", "Incident deleted successfully");
            } else {
                request.setAttribute("error", "Failed to delete incident");
            }
            
            response.sendRedirect(request.getContextPath() + "/admin/dashboard.jsp");
            
        } catch (NumberFormatException e) {
            request.setAttribute("error", "Invalid incident ID");
            redirectToDashboard(user, request, response);
        }
    }
    
    private void handleListIncidents(HttpServletRequest request, HttpServletResponse response, User user)
            throws ServletException, IOException {
        
        switch (user.getRole()) {
            case "ADMIN":
                request.setAttribute("incidents", incidentService.getAllIncidents());
                request.getRequestDispatcher("/admin/all-incidents.jsp").forward(request, response);
                break;
            case "OFFICER":
                request.setAttribute("incidents", incidentService.getOfficerIncidents(user.getUserId()));
                request.getRequestDispatcher("/officer/assigned-incidents.jsp").forward(request, response);
                break;
            case "CITIZEN":
                request.setAttribute("incidents", incidentService.getUserIncidents(user.getUserId()));
                request.getRequestDispatcher("/citizen/my-reports.jsp").forward(request, response);
                break;
            default:
                redirectToDashboard(user, request, response);
        }
    }
    
    private void handleSearchIncidents(HttpServletRequest request, HttpServletResponse response, User user)
            throws ServletException, IOException {
        
        String keyword = request.getParameter("keyword");
        String category = request.getParameter("category");
        String status = request.getParameter("status");
        String severity = request.getParameter("severity");
        
        java.util.List<Incident> incidents = incidentService.searchIncidents(keyword, category, status, severity);
        
        request.setAttribute("incidents", incidents);
        request.setAttribute("searchKeyword", keyword);
        request.setAttribute("searchCategory", category);
        request.setAttribute("searchStatus", status);
        request.setAttribute("searchSeverity", severity);
        
        // Forward to appropriate search results page
        String resultsPage = "/" + user.getRole().toLowerCase() + "/search-results.jsp";
        request.getRequestDispatcher(resultsPage).forward(request, response);
    }
    
    private void redirectToDashboard(User user, HttpServletRequest request, HttpServletResponse response)
            throws IOException {
        
        switch (user.getRole()) {
            case "ADMIN":
                response.sendRedirect(request.getContextPath() + "/admin/dashboard.jsp");
                break;
            case "OFFICER":
                response.sendRedirect(request.getContextPath() + "/officer/dashboard.jsp");
                break;
            case "CITIZEN":
                response.sendRedirect(request.getContextPath() + "/citizen/dashboard.jsp");
                break;
            default:
                response.sendRedirect(request.getContextPath() + "/login.jsp");
        }
    }
}
