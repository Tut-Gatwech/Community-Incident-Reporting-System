package com.incident.controller;

import com.incident.dao.IncidentDAO;
import com.incident.dao.UserDAO;
import com.incident.model.Incident;

import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.annotation.*;
import java.io.IOException;
import java.util.List;

@WebServlet("/reports/*")
public class ReportController extends HttpServlet {
    private IncidentDAO incidentDAO;
    private UserDAO userDAO;
    
    @Override
    public void init() {
        incidentDAO = new IncidentDAO();
        userDAO = new UserDAO();
    }
    
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        HttpSession session = request.getSession(false);
        if (session == null || session.getAttribute("user") == null) {
            response.sendRedirect(request.getContextPath() + "/login.jsp");
            return;
        }
        
        String path = request.getPathInfo();
        if (path == null || path.equals("/")) {
            path = "/dashboard";
        }
        
        String userRole = (String) session.getAttribute("userRole");
        
        switch (path) {
            case "/dashboard":
                showDashboard(request, response, userRole);
                break;
            case "/incidentSummary":
                showIncidentSummary(request, response);
                break;
            case "/categoryReport":
                showCategoryReport(request, response);
                break;
            case "/statusReport":
                showStatusReport(request, response);
                break;
            case "/userReport":
                if ("ADMIN".equals(userRole)) {
                    showUserReport(request, response);
                } else {
                    response.sendError(HttpServletResponse.SC_FORBIDDEN);
                }
                break;
            default:
                response.sendError(HttpServletResponse.SC_NOT_FOUND);
        }
    }
    
    private void showDashboard(HttpServletRequest request, HttpServletResponse response, String userRole)
            throws ServletException, IOException {
        // Get statistics
        int totalIncidents = incidentDAO.getIncidentCount();
        int openIncidents = incidentDAO.getIncidentCountByStatus("OPEN");
        int inProgressIncidents = incidentDAO.getIncidentCountByStatus("IN_PROGRESS");
        int resolvedIncidents = incidentDAO.getIncidentCountByStatus("RESOLVED");
        
        // Get recent incidents
        List<Incident> recentIncidents = incidentDAO.getAllIncidents();
        if (recentIncidents.size() > 10) {
            recentIncidents = recentIncidents.subList(0, 10);
        }
        
        request.setAttribute("totalIncidents", totalIncidents);
        request.setAttribute("openIncidents", openIncidents);
        request.setAttribute("inProgressIncidents", inProgressIncidents);
        request.setAttribute("resolvedIncidents", resolvedIncidents);
        request.setAttribute("recentIncidents", recentIncidents);
        request.setAttribute("userRole", userRole);
        
        request.getRequestDispatcher("/reports/dashboard.jsp").forward(request, response);
    }
    
    private void showIncidentSummary(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        List<Incident> allIncidents = incidentDAO.getAllIncidents();
        request.setAttribute("incidents", allIncidents);
        request.getRequestDispatcher("/reports/incident-summary.jsp").forward(request, response);
    }
    
    private void showCategoryReport(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        // This would typically involve more complex database queries
        // For now, we'll just show all incidents grouped by category
        List<Incident> incidents = incidentDAO.getAllIncidents();
        request.setAttribute("incidents", incidents);
        request.getRequestDispatcher("/reports/category-report.jsp").forward(request, response);
    }
    
    private void showStatusReport(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        List<Incident> openIncidents = incidentDAO.getIncidentsByStatus("OPEN");
        List<Incident> inProgressIncidents = incidentDAO.getIncidentsByStatus("IN_PROGRESS");
        List<Incident> resolvedIncidents = incidentDAO.getIncidentsByStatus("RESOLVED");
        
        request.setAttribute("openIncidents", openIncidents);
        request.setAttribute("inProgressIncidents", inProgressIncidents);
        request.setAttribute("resolvedIncidents", resolvedIncidents);
        request.getRequestDispatcher("/reports/status-report.jsp").forward(request, response);
    }
    
    private void showUserReport(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        // For admin only - show user activity report
        request.getRequestDispatcher("/reports/user-report.jsp").forward(request, response);
    }
}
